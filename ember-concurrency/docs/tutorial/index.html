<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>ember-concurrency</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
<meta name="dummy/config/environment" content="%7B%22modulePrefix%22%3A%22dummy%22%2C%22environment%22%3A%22production%22%2C%22rootURL%22%3A%22/ember-concurrency/%22%2C%22locationType%22%3A%22auto%22%2C%22EmberENV%22%3A%7B%22FEATURES%22%3A%7B%7D%2C%22EXTEND_PROTOTYPES%22%3A%7B%22Date%22%3Afalse%7D%7D%2C%22APP%22%3A%7B%22name%22%3A%22ember-concurrency%22%2C%22version%22%3A%220.8.14+50bc550a%22%7D%2C%22fastboot%22%3A%7B%22hostWhitelist%22%3A%5B%7B%7D%2C%22ember-concurrency.com%22%2C%22ef4.github.com%22%5D%7D%2C%22exportApplicationGlobal%22%3Afalse%7D" />
<!-- EMBER_CLI_FASTBOOT_TITLE -->

    <link integrity="" rel="stylesheet" href="/ember-concurrency/assets/vendor-e754b247f0b14ad5fde0f302404dd7cb.css">
    <link integrity="" rel="stylesheet" href="/ember-concurrency/assets/dummy-7f48877695f90667ea4c9e336bd96024.css">
    <link href='//fonts.googleapis.com/css?family=Raleway:400,300,600' rel='stylesheet' type='text/css'>

    
  </head>
  <body>
    <div id="ember710" class="ember-view"><div class="container navbar">
  <div class="row">
    <div class="ten columns">
      <h3 style="float:left;">
        ember-concurrency

        <span style="font-size: 0.5em;">
          (v 0.8.14)
        </span>
      </h3>
    </div>
    <div class="one columns">
      <div class="nav-bar-link-outer">
        <a href="/api">API</a>
      </div>
    </div>
    <div class="one columns">
      <div class="nav-bar-link-outer">
        <a href="https://github.com/machty/ember-concurrency" target="_blank">GitHub</a>
      </div>
    </div>
  </div>
</div>

<div class="container">
  <div class="docs row">
    <div class="three columns">
      <div class="side-menu">
            <div class="toc-entry">
                <a href="/ember-concurrency/docs/introduction" id="ember713" class="ember-view">Home</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/ember-concurrency/docs/installation" id="ember717" class="ember-view">Installation</a>
            </div>


<!---->            <div class="toc-section-title">
              Introduction
            </div>
            <div class="toc-entry">
                <a href="/ember-concurrency/docs/tutorial" id="ember721" class="active ember-view">Writing Code Without Tasks</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/ember-concurrency/docs/tutorial/discussion" id="ember722" class="ember-view">Post-Mortem</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/ember-concurrency/docs/tutorial/refactor" id="ember726" class="ember-view">Refactoring With Tasks</a>
            </div>


<!---->            <div class="toc-section-title">
              Reference
            </div>
            <div class="toc-entry">
                <a href="/ember-concurrency/docs/task-function-syntax" id="ember730" class="ember-view">Task Function Syntax</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/ember-concurrency/docs/task-concurrency" id="ember734" class="ember-view">Managing Task Concurrency</a>
            </div>


                <div class="toc-entry toc-subentry">
                  <a href="/ember-concurrency/docs/task-concurrency-advanced" id="ember738" class="ember-view">Advanced</a>
                  </div>
            <div class="toc-entry">
                <a href="/ember-concurrency/docs/cancelation" id="ember742" class="ember-view">Cancelation</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/ember-concurrency/docs/error-vs-cancelation" id="ember746" class="ember-view">Handling Errors</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/ember-concurrency/docs/child-tasks" id="ember750" class="ember-view">Child Tasks</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/ember-concurrency/docs/task-groups" id="ember754" class="ember-view">Task Groups</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/ember-concurrency/docs/derived-state" id="ember758" class="ember-view">Derived State</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/ember-concurrency/docs/encapsulated-task" id="ember762" class="ember-view">Encapsulated Tasks</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/ember-concurrency/docs/events" id="ember766" class="ember-view">Ember &amp; DOM / jQuery Events</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/ember-concurrency/docs/testing-debugging" id="ember770" class="ember-view">Testing &amp; Debugging</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/ember-concurrency/docs/faq" id="ember774" class="ember-view">FAQ &amp; Fact Sheet</a>
            </div>


<!---->            <div class="toc-section-title">
              Examples
            </div>
            <div class="toc-entry">
                <a href="/ember-concurrency/docs/examples/loading-ui" id="ember778" class="ember-view">Loading UI</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/ember-concurrency/docs/examples/autocomplete" id="ember785" class="ember-view">Type-Ahead Search</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/ember-concurrency/docs/examples/increment-buttons" id="ember789" class="ember-view">Accelerating Increment Buttons</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/ember-concurrency/docs/examples/ajax-throttling" id="ember793" class="ember-view">AJAX Throttling</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/ember-concurrency/docs/examples/route-tasks" id="ember797" class="ember-view">Route Tasks</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/ember-concurrency/docs/examples/joining-tasks" id="ember801" class="ember-view">Awaiting Multiple Child Tasks</a>
            </div>


<!---->      </div>
    </div>
    <div class="nine columns">
      <div class="row">
    <p class="u-pull-left">
      Previous: <a href="/ember-concurrency/docs/installation" id="ember805" class="ember-view">Installation</a>
    </p>

    <p class="u-pull-right">
      Next: <a href="/ember-concurrency/docs/tutorial/discussion" id="ember806" class="ember-view">Post-Mortem</a>
    </p>
</div>


      <a title="Edit on Github" href="https://github.com/machty/ember-concurrency/edit/master/tests/dummy/app/docs/tutorial/index/template.hbs" id="ember807" class="github-edit ember-view"><i class="icon-pencil"></i>
</a>

      <h3>Introduction to ember-concurrency</h3>

<p>
To demonstrate the kinds of problems ember-concurrency
is designed to solve, we'll first implement a basic example of
loading data in a Component using only core Ember APIs. Then
we'll introduce ember-concurrency tasks as part of a refactor.
</p>

<p>
This tutorial (and ember-concurrency itself) assumes that you have
reasonable familiarity with Ember's core APIs, particularly surrounding
Components, templates, actions, and Promises.
</p>

<p>
For our use case, we're going to implement a Component that
fetches and displays nearby retail stores. This involves
a two-step asynchronous process:
</p>

<ol>
  <li>
    It uses geolocation to find the user's latitude/longitude coordinates, and then:
  </li>
  <li>
    It forwards those coordinates to the server to fetch a list of nearby restaurants.
  </li>
</ol>

<p>
<em>
This is basically the same example demonstrated in the
<a href="https://youtu.be/VEzVDOmY-dc?t=123">EmberConf 2017 ember-concurrency talk</a>;
take a look if you prefer a video alternative to this tutorial.
</em>
</p>

<h4>Version 1: Bare Minimum Implementation</h4>

<p>
We'll start off a bare-bones implementation of the feature: within
an action called <code>findStores</code>, we'll create a Promise
chain that fetches the coordinates from a geolocation service
and passes those coordinates to a store's <code>getNearbyStores</code>
method, which eventually gives us an array of stores that we stash
on the <code>result</code> property so that the stores can be displayed
in the template.
</p>

<div id="ember826" class="code-template-toggle ember-view"><div class="code-template-toggle-section hidden">
  <pre id="ember827" class="htmlbars ember-view">&lt;button onclick={{action 'findStores'}}&gt;
  Find Nearby Stores
&lt;/button&gt;

{{#if result}}
  {{#each result.stores as |s|}}
    &lt;li&gt;
      &lt;strong&gt;{{s.name}}&lt;/strong&gt;:
      {{s.distance}} miles away
    &lt;/li&gt;
  {{/each}}
{{/if}}
</pre>
</div>
<div class="code-template-toggle-section ">
  <pre id="ember828" class="javascript ember-view">export default TutorialComponent.extend({
  result: null,
  actions: {
    findStores() {
      let geolocation = this.get('geolocation');
      let store = this.get('store');

      geolocation.getCoords()
        .then(coords =&gt; store.getNearbyStores(coords))
        .then(result =&gt; {
          this.set('result', result);
        });
    }
  },
});
</pre>
</div>
<span class="button code-template-toggle-button">
  Toggle JS / Template
</span>
</div>
<div id="ember833" class="ember-view"><div class="tutorial-example">

  <button>
    Find Nearby Stores
  </button>

<!---->
  <span class="tutorial-example-label">Example</span>
</div>
</div>

<p>
This first implementation <em>works</em>, but it's not really production-ready.
The most immediate problem is that there's no loading UI; the user clicks
the button and it seems like nothing is happening until the results come back.
</p>

<h4>Version 2: Add a Loading Spinner</h4>

<p>
We'd like to display a loading spinner while the code is fetching nearby stores.
In order to do this, we'll add an <code>isFindingStores</code> property to the
component that the template can use to display a spinner.
</p>

<p><em>
  We'll use <code>++</code> comments to highlight newly added code.
</em></p>

<div id="ember834" class="code-template-toggle ember-view"><div class="code-template-toggle-section hidden">
  <pre id="ember835" class="htmlbars ember-view">&lt;button onclick={{action 'findStores'}}&gt;
  Find Nearby Stores
  {{#if isFindingStores}}
    {{! ++ }}
    {{loading-spinner}}
  {{/if}}
&lt;/button&gt;

{{#if result}}
  {{#each result.stores as |s|}}
    &lt;li&gt;
      &lt;strong&gt;{{s.name}}&lt;/strong&gt;:
      {{s.distance}} miles away
    &lt;/li&gt;
  {{/each}}
{{/if}}
</pre>
</div>
<div class="code-template-toggle-section ">
  <pre id="ember836" class="javascript ember-view">export default TutorialComponent.extend({
  result: null,
  isFindingStores: false, // ++
  actions: {
    findStores() {
      let geolocation = this.get('geolocation');
      let store = this.get('store');

      this.set('isFindingStores', true); // ++
      geolocation.getCoords()
        .then(coords =&gt; store.getNearbyStores(coords))
        .then(result =&gt; {
          this.set('result', result);
          this.set('isFindingStores', false); // ++
        });
    }
  },
});
</pre>
</div>
<span class="button code-template-toggle-button">
  Toggle JS / Template
</span>
</div>
<div id="ember839" class="ember-view"><div class="tutorial-example">

  <button>
    Find Nearby Stores
<!---->  </button>

<!---->
  <span class="tutorial-example-label">Example</span>
</div>
</div>

<p>
This is certainly an improvement, but strange things start to happen if you
click the "Find Nearby Stores" button many times in a row.
</p>

<p>
The problem is that we're kicking off multiple concurrent attempts to fetch
nearby locations, when really we just want only one fetch to be running
at any given time.
</p>

<h4>Version 3: Preventing Concurrency</h4>

<p>
We'd like to prevent another fetch from happening if one is already in
progress. To do this, just need to add a check to see if
<code>isFindingStores</code> is true, and return early if so.
</p>

<div id="ember840" class="code-template-toggle ember-view"><div class="code-template-toggle-section hidden">
  <pre id="ember841" class="htmlbars ember-view">&lt;button onclick={{action 'findStores'}}&gt;
  Find Nearby Stores
  {{#if isFindingStores}}
    {{loading-spinner}}
  {{/if}}
&lt;/button&gt;

{{#if result}}
  {{#each result.stores as |s|}}
    &lt;li&gt;
      &lt;strong&gt;{{s.name}}&lt;/strong&gt;:
      {{s.distance}} miles away
    &lt;/li&gt;
  {{/each}}
{{/if}}
</pre>
</div>
<div class="code-template-toggle-section ">
  <pre id="ember842" class="javascript ember-view">export default TutorialComponent.extend({
  result: null,
  isFindingStores: false,
  actions: {
    findStores() {
      if (this.isFindingStores) { return; } // ++

      let geolocation = this.get('geolocation');
      let store = this.get('store');

      this.set('isFindingStores', true);
      geolocation.getCoords()
        .then(coords =&gt; store.getNearbyStores(coords))
        .then(result =&gt; {
          this.set('result', result);
          this.set('isFindingStores', false);
        });
    }
  },
});
</pre>
</div>
<span class="button code-template-toggle-button">
  Toggle JS / Template
</span>
</div>
<div id="ember845" class="ember-view"><div class="tutorial-example">

  <button>
    Find Nearby Stores
<!---->  </button>

<!---->
  <span class="tutorial-example-label">Example</span>
</div>
</div>

<p>
Now it is safe to tap the "Find Nearby Stores" button. Are we done?
</p>

<p>
Unfortunately, no. There's an important corner case we haven't addressed yet:
if the component is destroyed (because the user navigated
to a different page) while the fetch is running, our code
will throw an Error with the message
<code>"calling set on destroyed object"</code>.
</p>

<p>
You can
actually verify that this happening by opening your browser's
web inspector, clicking "Find Nearby Stores" from the example
above, and then quickly clicking <a href="/ember-concurrency/docs/introduction" id="ember846" class="ember-view">this link</a>
before the store results have come back.
</p>

<h4>Version 4: Handling "set on destroyed object" errors</h4>

<p>
The problem is that it's possible for our promise callback (the
one that sets <code>result</code> and <code>isFindingStores</code>)
to run after the component has been destroyed, and Ember (and React
and many others) will complain if you try and, well, call <code>set()</code>
on a destroyed object.
</p>

<p>
Fortunately, Ember let's us check if an object has been destroyed
via the <code>isDestroyed</code> flag, so we can just add a bit of
defensive programming to our promise callback as follows:
</p>

<div id="ember847" class="code-template-toggle ember-view"><div class="code-template-toggle-section hidden">
  <pre id="ember848" class="htmlbars ember-view">&lt;button onclick={{action 'findStores'}}&gt;
  Find Nearby Stores
  {{#if isFindingStores}}
    {{loading-spinner}}
  {{/if}}
&lt;/button&gt;

{{#if result}}
  {{#each result.stores as |s|}}
    &lt;li&gt;
      &lt;strong&gt;{{s.name}}&lt;/strong&gt;:
      {{s.distance}} miles away
    &lt;/li&gt;
  {{/each}}
{{/if}}
</pre>
</div>
<div class="code-template-toggle-section ">
  <pre id="ember849" class="javascript ember-view">export default TutorialComponent.extend({
  result: null,
  isFindingStores: false,
  actions: {
    findStores() {
      if (this.isFindingStores) { return; }

      let geolocation = this.get('geolocation');
      let store = this.get('store');

      this.set('isFindingStores', true);
      geolocation.getCoords()
        .then(coords =&gt; store.getNearbyStores(coords))
        .then(result =&gt; {
          if (this.isDestroyed) { return; } // ++
          this.set('result', result);
          this.set('isFindingStores', false);
        });
    }
  },
});
</pre>
</div>
<span class="button code-template-toggle-button">
  Toggle JS / Template
</span>
</div>
<div id="ember852" class="ember-view"><div class="tutorial-example">

  <button>
    Find Nearby Stores
<!---->  </button>

<!---->
  <span class="tutorial-example-label">Example</span>
</div>
</div>

<p>
Now if you click "Find Nearby Stores" and
<a href="/ember-concurrency/docs/introduction" id="ember853" class="ember-view">navigate elsewhere</a>, you won't see
that pesky error.
</p>

<p>
Now, are we done?
</p>

<h4>Version 5: Handle Promise Rejection</h4>

<p>
You might have noticed that we don't have any error handling if
either the <code>getCoords</code> or <code>getNearbyStores</code>
promises reject with an error.
</p>

<p>
Even if we were too lazy to build
an error banner or popup to indicate that something went wrong (and we are),
the least we could do is make sure that our code gracefully
recovers from such an error and doesn't wind up in a bad state.
As it stands, if one of those promises rejected,
<code>isFindingStores</code> would be stuck to <code>true</code>, and
there'd be no way to try fetching again.
</p>

<p>
Let's use a <code>finally()</code> handler to make sure that
<code>isFindingStores</code> always gets set to <code>false</code>,
regardless of success or failure. Unfortunately, this also
means we have to duplicate our <code>isDestroyed</code> check.
</p>

<div id="ember854" class="code-template-toggle ember-view"><div class="code-template-toggle-section hidden">
  <pre id="ember855" class="htmlbars ember-view">&lt;button onclick={{action 'findStores'}}&gt;
  Find Nearby Stores
  {{#if isFindingStores}}
    {{loading-spinner}}
  {{/if}}
&lt;/button&gt;

{{#if result}}
  {{#each result.stores as |s|}}
    &lt;li&gt;
      &lt;strong&gt;{{s.name}}&lt;/strong&gt;:
      {{s.distance}} miles away
    &lt;/li&gt;
  {{/each}}
{{/if}}
</pre>
</div>
<div class="code-template-toggle-section ">
  <pre id="ember856" class="javascript ember-view">export default TutorialComponent.extend({
  result: null,
  isFindingStores: false,
  actions: {
    findStores() {
      if (this.isFindingStores) { return; }

      let geolocation = this.get('geolocation');
      let store = this.get('store');

      this.set('isFindingStores', true);
      geolocation.getCoords()
        .then(coords =&gt; store.getNearbyStores(coords))
        .then(result =&gt; {
          if (this.isDestroyed) { return; }
          this.set('result', result);
        })
        .finally(() =&gt; {                      // ++
          if (this.isDestroyed) { return; }   // ++
          this.set('isFindingStores', false); // ++
        });
    }
  },
});
</pre>
</div>
<span class="button code-template-toggle-button">
  Toggle JS / Template
</span>
</div>
<div id="ember859" class="ember-view"><div class="tutorial-example">

  <button>
    Find Nearby Stores
<!---->  </button>

<!---->
  <span class="tutorial-example-label">Example</span>
</div>
</div>

<p>
And there you have it: a reasonably-production ready implementation
of finding nearby stores.
</p>



      <br> <br> <br> <br> 

      <div class="row">
    <p class="u-pull-left">
      Previous: <a href="/ember-concurrency/docs/installation" id="ember860" class="ember-view">Installation</a>
    </p>

    <p class="u-pull-right">
      Next: <a href="/ember-concurrency/docs/tutorial/discussion" id="ember861" class="ember-view">Post-Mortem</a>
    </p>
</div>


    </div>
  </div>
</div>


<div id="ember862" class="ember-notify-cn ember-notify-default ember-view"><!----></div>
</div>

    <script src="/ember-concurrency/assets/vendor-5f94e20cd7ff4ec97d6a6a3b5639223f.js"></script>
    <script src="/ember-concurrency/assets/dummy-72adf74a268ccaf64e1eadff9fee5dbf.js"></script>

    
  </body>
</html>
