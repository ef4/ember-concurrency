<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>ember-concurrency</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
<meta name="dummy/config/environment" content="%7B%22modulePrefix%22%3A%22dummy%22%2C%22environment%22%3A%22production%22%2C%22rootURL%22%3A%22/ember-concurrency/%22%2C%22locationType%22%3A%22auto%22%2C%22EmberENV%22%3A%7B%22FEATURES%22%3A%7B%7D%2C%22EXTEND_PROTOTYPES%22%3A%7B%22Date%22%3Afalse%7D%7D%2C%22APP%22%3A%7B%22name%22%3A%22ember-concurrency%22%2C%22version%22%3A%220.8.14+50bc550a%22%7D%2C%22fastboot%22%3A%7B%22hostWhitelist%22%3A%5B%7B%7D%2C%22ember-concurrency.com%22%2C%22ef4.github.com%22%5D%7D%2C%22exportApplicationGlobal%22%3Afalse%7D" />
<!-- EMBER_CLI_FASTBOOT_TITLE -->

    <link integrity="" rel="stylesheet" href="/ember-concurrency/assets/vendor-e754b247f0b14ad5fde0f302404dd7cb.css">
    <link integrity="" rel="stylesheet" href="/ember-concurrency/assets/dummy-7f48877695f90667ea4c9e336bd96024.css">
    <link href='//fonts.googleapis.com/css?family=Raleway:400,300,600' rel='stylesheet' type='text/css'>

    
  </head>
  <body>
    <div id="ember1014" class="ember-view"><div class="container navbar">
  <div class="row">
    <div class="ten columns">
      <h3 style="float:left;">
        ember-concurrency

        <span style="font-size: 0.5em;">
          (v 0.8.14)
        </span>
      </h3>
    </div>
    <div class="one columns">
      <div class="nav-bar-link-outer">
        <a href="/api">API</a>
      </div>
    </div>
    <div class="one columns">
      <div class="nav-bar-link-outer">
        <a href="https://github.com/machty/ember-concurrency" target="_blank">GitHub</a>
      </div>
    </div>
  </div>
</div>

<div class="container">
  <div class="docs row">
    <div class="three columns">
      <div class="side-menu">
            <div class="toc-entry">
                <a href="/ember-concurrency/docs/introduction" id="ember1017" class="ember-view">Home</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/ember-concurrency/docs/installation" id="ember1021" class="ember-view">Installation</a>
            </div>


<!---->            <div class="toc-section-title">
              Introduction
            </div>
            <div class="toc-entry">
                <a href="/ember-concurrency/docs/tutorial" id="ember1025" class="ember-view">Writing Code Without Tasks</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/ember-concurrency/docs/tutorial/discussion" id="ember1029" class="ember-view">Post-Mortem</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/ember-concurrency/docs/tutorial/refactor" id="ember1033" class="active ember-view">Refactoring With Tasks</a>
            </div>


<!---->            <div class="toc-section-title">
              Reference
            </div>
            <div class="toc-entry">
                <a href="/ember-concurrency/docs/task-function-syntax" id="ember1034" class="ember-view">Task Function Syntax</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/ember-concurrency/docs/task-concurrency" id="ember1038" class="ember-view">Managing Task Concurrency</a>
            </div>


                <div class="toc-entry toc-subentry">
                  <a href="/ember-concurrency/docs/task-concurrency-advanced" id="ember1042" class="ember-view">Advanced</a>
                  </div>
            <div class="toc-entry">
                <a href="/ember-concurrency/docs/cancelation" id="ember1046" class="ember-view">Cancelation</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/ember-concurrency/docs/error-vs-cancelation" id="ember1050" class="ember-view">Handling Errors</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/ember-concurrency/docs/child-tasks" id="ember1054" class="ember-view">Child Tasks</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/ember-concurrency/docs/task-groups" id="ember1058" class="ember-view">Task Groups</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/ember-concurrency/docs/derived-state" id="ember1062" class="ember-view">Derived State</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/ember-concurrency/docs/encapsulated-task" id="ember1066" class="ember-view">Encapsulated Tasks</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/ember-concurrency/docs/events" id="ember1070" class="ember-view">Ember &amp; DOM / jQuery Events</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/ember-concurrency/docs/testing-debugging" id="ember1074" class="ember-view">Testing &amp; Debugging</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/ember-concurrency/docs/faq" id="ember1078" class="ember-view">FAQ &amp; Fact Sheet</a>
            </div>


<!---->            <div class="toc-section-title">
              Examples
            </div>
            <div class="toc-entry">
                <a href="/ember-concurrency/docs/examples/loading-ui" id="ember1082" class="ember-view">Loading UI</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/ember-concurrency/docs/examples/autocomplete" id="ember1089" class="ember-view">Type-Ahead Search</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/ember-concurrency/docs/examples/increment-buttons" id="ember1093" class="ember-view">Accelerating Increment Buttons</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/ember-concurrency/docs/examples/ajax-throttling" id="ember1097" class="ember-view">AJAX Throttling</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/ember-concurrency/docs/examples/route-tasks" id="ember1101" class="ember-view">Route Tasks</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/ember-concurrency/docs/examples/joining-tasks" id="ember1105" class="ember-view">Awaiting Multiple Child Tasks</a>
            </div>


<!---->      </div>
    </div>
    <div class="nine columns">
      <div class="row">
    <p class="u-pull-left">
      Previous: <a href="/ember-concurrency/docs/tutorial/discussion" id="ember1109" class="ember-view">Post-Mortem</a>
    </p>

    <p class="u-pull-right">
      Next: <a href="/ember-concurrency/docs/task-function-syntax" id="ember1110" class="ember-view">Task Function Syntax</a>
    </p>
</div>


      <a title="Edit on Github" href="https://github.com/machty/ember-concurrency/edit/master/tests/dummy/app/docs/tutorial/refactor/template.hbs" id="ember1111" class="github-edit ember-view"><i class="icon-pencil"></i>
</a>

      <h3>Refactoring With Tasks</h3>

<p>
Now we're going to build the same functionality using
ember-concurrency tasks, starting with the same bare minimum
implementation as before, and making incremental improvements.
</p>

<p>
For reference, here is the bare minimum implementation that we
started with before (which only uses core Ember APIs):
</p>

<div id="ember1120" class="code-template-toggle ember-view"><div class="code-template-toggle-section hidden">
  <pre id="ember1121" class="htmlbars ember-view">&lt;button onclick={{action 'findStores'}}&gt;
  Find Nearby Stores
&lt;/button&gt;

{{#if result}}
  {{#each result.stores as |s|}}
    &lt;li&gt;
      &lt;strong&gt;{{s.name}}&lt;/strong&gt;:
      {{s.distance}} miles away
    &lt;/li&gt;
  {{/each}}
{{/if}}
</pre>
</div>
<div class="code-template-toggle-section ">
  <pre id="ember1122" class="javascript ember-view">export default TutorialComponent.extend({
  result: null,
  actions: {
    findStores() {
      let geolocation = this.get('geolocation');
      let store = this.get('store');

      geolocation.getCoords()
        .then(coords =&gt; store.getNearbyStores(coords))
        .then(result =&gt; {
          this.set('result', result);
        });
    }
  },
});
</pre>
</div>
<span class="button code-template-toggle-button">
  Toggle JS / Template
</span>
</div>
<div id="ember1123" class="ember-view"><div class="tutorial-example">

  <button>
    Find Nearby Stores
  </button>

<!---->
  <span class="tutorial-example-label">Example</span>
</div>
</div>

<h4>Version 1: Bare Minimum Implementation (with Tasks)</h4>

<p>
Now let's build the same thing with ember-concurrency tasks:
</p>

<div id="ember1124" class="code-template-toggle ember-view"><div class="code-template-toggle-section hidden">
  <pre id="ember1125" class="htmlbars ember-view">&lt;button onclick={{perform findStores}}&gt; {{! ++ }}
  Find Nearby Stores
&lt;/button&gt;

{{#if result}}
  {{#each result.stores as |s|}}
    &lt;li&gt;
      &lt;strong&gt;{{s.name}}&lt;/strong&gt;:
      {{s.distance}} miles away
    &lt;/li&gt;
  {{/each}}
{{/if}}
</pre>
</div>
<div class="code-template-toggle-section ">
  <pre id="ember1126" class="javascript ember-view">import { task } from 'ember-concurrency';

export default TutorialComponent.extend({
  result: null,

  findStores: task(function * () {
    let geolocation = this.get('geolocation');
    let store = this.get('store');

    let coords = yield geolocation.getCoords();
    let result = yield store.getNearbyStores(coords);
    this.set('result', result);
  }),
});
</pre>
</div>
<span class="button code-template-toggle-button">
  Toggle JS / Template
</span>
</div>
<div id="ember1129" class="ember-view"><div class="tutorial-example">

  <button> 
    Find Nearby Stores
  </button>

<!---->
  <span class="tutorial-example-label">Example</span>
</div>
</div>

<p>
Let's take a moment to point out everything that has changed:
</p>

<p>
  First, instead of using a <code>findStores</code> <em>action</em>,
  we define a <code>findStores</code> <em>task</em>.
</p>

<p>
  Second, in the template, instead of using <code>onclick={{action 'findStores'}}</code>,
  we use <code>onclick={{perform findStores}}</code>.
</p>

<p>
  Lastly, instead of using a Promise chain of <code>.then()</code> callbacks,
  we use the
  <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function*">Generator Function Syntax</a>
  and the <code>yield</code> keyword.
</p>

<p>
  <a href="/ember-concurrency/docs/task-function-syntax" id="ember1136" class="ember-view">We'll get into much greater detail</a>
  about how this syntax is used, but for now, the most important thing to understand
  is that when you <code>yield</code> a promise, the task will pause until that promise fulfills,
  and then continue executing with the resolved value of that promise.
</p>

<p>Let's press onward with the refactor:</p>

<h5>Version 2: Add a Loading Spinner (with Tasks)</h5>

<p>
Rather than defining a separate boolean flag and manually tracking
the state of the task, we can use the <code>isRunning</code> property
exposed by the task to drive our loading spinner, which means we only
need to make a change to the template code; the JavaScript can stay the same:
</p>

<div id="ember1137" class="code-template-toggle ember-view"><div class="code-template-toggle-section ">
  <pre id="ember1138" class="htmlbars ember-view">&lt;button onclick={{perform findStores}}&gt;
  Find Nearby Stores
  {{#if findStores.isRunning}}
    {{! ++ }}
    {{loading-spinner}}
  {{/if}}
&lt;/button&gt;

{{#if result}}
  {{#each result.stores as |s|}}
    &lt;li&gt;
      &lt;strong&gt;{{s.name}}&lt;/strong&gt;:
      {{s.distance}} miles away
    &lt;/li&gt;
  {{/each}}
{{/if}}
</pre>
</div>
<div class="code-template-toggle-section hidden">
  <pre id="ember1139" class="javascript ember-view">import { task } from 'ember-concurrency';

export default TutorialComponent.extend({
  result: null,

  findStores: task(function * () {
    let geolocation = this.get('geolocation');
    let store = this.get('store');

    let coords = yield geolocation.getCoords();
    let result = yield store.getNearbyStores(coords);
    this.set('result', result);
  }),
});
</pre>
</div>
<span class="button code-template-toggle-button">
  Toggle JS / Template
</span>
</div>
<div id="ember1142" class="ember-view"><div class="tutorial-example">

  <button>
    Find Nearby Stores
<!---->  </button>

<!---->
  <span class="tutorial-example-label">Example</span>
</div>
</div>

<h4>Version 3: Preventing Concurrency (with Tasks)</h4>

<p>
So far so good, but we still haven't addressed the issue that clicking
the button multiple times causes weird behavior due to multiple
fetch operations running at the same time.
</p>

<p>
Rather than putting an <code>if</code> guard at the start of the task,
the ember-concurrency way to prevent concurrency is to apply a
<a href="/ember-concurrency/docs/task-concurrency" id="ember1143" class="ember-view">Task Modifier</a> to the task.
The one we want to use is the <code>.drop()</code> modifier, which prevents
concurrency by "dropping" any attempt to perform the task while it is
already running.
</p>

<div id="ember1144" class="code-template-toggle ember-view"><div class="code-template-toggle-section hidden">
  <pre id="ember1145" class="htmlbars ember-view">&lt;button onclick={{perform findStores}}&gt;
  Find Nearby Stores
  {{#if findStores.isRunning}}
    {{loading-spinner}}
  {{/if}}
&lt;/button&gt;

{{#if result}}
  {{#each result.stores as |s|}}
    &lt;li&gt;
      &lt;strong&gt;{{s.name}}&lt;/strong&gt;:
      {{s.distance}} miles away
    &lt;/li&gt;
  {{/each}}
{{/if}}
</pre>
</div>
<div class="code-template-toggle-section ">
  <pre id="ember1146" class="javascript ember-view">import { task } from 'ember-concurrency';

export default TutorialComponent.extend({
  result: null,

  findStores: task(function * () {
    let geolocation = this.get('geolocation');
    let store = this.get('store');

    let coords = yield geolocation.getCoords();
    let result = yield store.getNearbyStores(coords);
    this.set('result', result);
  }).drop(), // ++
});
</pre>
</div>
<span class="button code-template-toggle-button">
  Toggle JS / Template
</span>
</div>
<div id="ember1149" class="ember-view"><div class="tutorial-example">

  <button>
    Find Nearby Stores
<!---->  </button>

<!---->
  <span class="tutorial-example-label">Example</span>
</div>
</div>

<p>
Now when you button mash "Find Nearby Stores", you no longer get the weird
behavior due to concurrent fetches.
</p>

<h4>Version 4: Handling "set on destroyed object" errors (with Tasks)</h4>

<p>
What about those pesky <code>"set on destroyed object"</code> errors?
</p>

<p>
Good news! Our code is already safe because ember-concurrency automatically
cancels tasks when their host object (e.g. a Component) is destroyed.
In our example, if the <code>findStores</code> task is paused
at the unresolved <code>getNearbyStores</code> promise right when the user navigates
away, the component will be destroyed and the <code>findStores</code> task will
stop right where it is and will never hit the line of code with the <code>this.set()</code>,
thus avoiding the <code>"set on destroyed object"</code> error.
</p>

<p>
The ability to cancel a task in mid-execution is one of ember-concurrency's
most powerful features, and it is the generator function syntax that
makes cancelation possible.
</p>

<h4>Version 5: Handle Promise Rejection (with Tasks)</h4>

<p>
Will a promise rejection put our task into an unrecoverable state?
</p>

<p>
It turns out that, again, we don't need to change any code; if either
<code>getCoords</code> or <code>getNearbyStores</code> returned a rejecting promise,
the <code>findStores</code> task would stop execution where the error occurred, bubble
the exception to the console (so that error reporters can catch it), but from there on
the task can be immediately performed / retried again. So, we don't need to change any code.
</p>

<h3>Final Diff</h3>

<p>
JavaScript:
</p>

<div id="ember1150" class="code-template-toggle ember-view"><div class="code-template-toggle-section hidden">
  <pre id="ember1151" class="javascript ember-view">export default TutorialComponent.extend({
  result: null,
  isFindingStores: false,
  actions: {
    findStores() {
      if (this.isFindingStores) { return; }

      let geolocation = this.get('geolocation');
      let store = this.get('store');

      this.set('isFindingStores', true);
      geolocation.getCoords()
        .then(coords =&gt; store.getNearbyStores(coords))
        .then(result =&gt; {
          if (this.isDestroyed) { return; }
          this.set('result', result);
        })
        .finally(() =&gt; {
          if (this.isDestroyed) { return; }
          this.set('isFindingStores', false);
        });
    }
  },
});
</pre>
</div>
<div class="code-template-toggle-section ">
  <pre id="ember1152" class="javascript ember-view">export default TutorialComponent.extend({
  result: null,
  findStores: task(function * () {
    let geolocation = this.get('geolocation');
    let store = this.get('store');

    let coords = yield geolocation.getCoords();
    let result = yield store.getNearbyStores(coords);
    this.set('result', result);
  }).drop(),
});
</pre>
</div>
<span class="button code-template-toggle-button">
  diff
</span>
</div>

<p>
<br>
Template:
</p>

<div id="ember1153" class="code-template-toggle ember-view"><div class="code-template-toggle-section hidden">
  <pre id="ember1154" class="htmlbars ember-view">&lt;button onclick={{action 'findStores'}}&gt;
  Find Nearby Stores
  {{#if isFindingStores}}
    {{loading-spinner}}
  {{/if}}
&lt;/button&gt;

{{#if result}}
  {{#each result.stores as |s|}}
    &lt;li&gt;
      &lt;strong&gt;{{s.name}}&lt;/strong&gt;:
      {{s.distance}} miles away
    &lt;/li&gt;
  {{/each}}
{{/if}}
</pre>
</div>
<div class="code-template-toggle-section ">
  <pre id="ember1155" class="htmlbars ember-view">&lt;button onclick={{perform findStores}}&gt;
  Find Nearby Stores
  {{#if findStores.isRunning}}
    {{loading-spinner}}
  {{/if}}
&lt;/button&gt;

{{#if result}}
  {{#each result.stores as |s|}}
    &lt;li&gt;
      &lt;strong&gt;{{s.name}}&lt;/strong&gt;:
      {{s.distance}} miles away
    &lt;/li&gt;
  {{/each}}
{{/if}}
</pre>
</div>
<span class="button code-template-toggle-button">
  diff
</span>
</div>

<br>
<h3>Conclusion</h3>

<p>
This was a very successful refactor. We were able to remove a lot
of ugly boilerplate and defensive programming code, and what we're left
with is very clean, concise, safe, and stress-free code.
</p>



      <br> <br> <br> <br> 

      <div class="row">
    <p class="u-pull-left">
      Previous: <a href="/ember-concurrency/docs/tutorial/discussion" id="ember1156" class="ember-view">Post-Mortem</a>
    </p>

    <p class="u-pull-right">
      Next: <a href="/ember-concurrency/docs/task-function-syntax" id="ember1157" class="ember-view">Task Function Syntax</a>
    </p>
</div>


    </div>
  </div>
</div>


<div id="ember1158" class="ember-notify-cn ember-notify-default ember-view"><!----></div>
</div>

    <script src="/ember-concurrency/assets/vendor-5f94e20cd7ff4ec97d6a6a3b5639223f.js"></script>
    <script src="/ember-concurrency/assets/dummy-72adf74a268ccaf64e1eadff9fee5dbf.js"></script>

    
  </body>
</html>
